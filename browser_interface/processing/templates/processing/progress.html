{% extends 'core/lcars_app.html' %}
{% load static %}

{% block header_title %}
AutoWISP Reductions Progress
{% endblock header_title %}

{% block extra_head %}
{% if refresh_seconds %}
<meta http-equiv="refresh" content="{{refresh_seconds}}">
{% endif %}
<link rel="stylesheet" 
      href="{% static 'processing/css/jquery.orgchart.css' %}">
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
<style type="text/css">
#chart-container { text-align: left; }

.dropdown:hover .dropbtn {
    display: none;
}
</style>
{% endblock extra_head %}

{% block app_title %}
Processing Progress
{% endblock app_title %}

{% block left_menu %}
{% if not running %}
<a href="{% url 'processing:start_processing' %}">
    <div class="lcars-element 
                              button 
                              lcars-melrose-bg
                              lcars-u-1">
        Start Processing
    </div>
</a>
{% endif %}

<a href="{% url 'processing:select_raw_images' %}">
    <div class="lcars-element 
                              button 
                              lcars-husk-bg
                              lcars-u-1">
        Add New Images
    </div>
</a>
{% endblock left_menu %}

{% block main %}
<table class="lcars-table standard-header">
    <thead>
        <tr>
            <th>Step</th>
            <th>Image Type</th>
            {% for channel in channels %}
            <th style="justify-content: center;">{{ channel }}</th>
            {% endfor %}
        </tr>
    </thead>
    {% for step, imtype, by_channel, runs in progress %}
    <tr>
        <td>
            <a href="{% url 'configuration:config_tree' step=step|join:"_" version=0 %}">
                <div class="lcars-element 
                                          button 
                                          rounded 
                                          lcars-chestnut-rose-bg
                                          lcars-u-2"
                     style="align-items: center;">
                    {{ step|join:" " }}
                </div>
            </a>
        </td>
        <td>{{ imtype }}</td>
        {% url 'processing:select_photref_target' as photrefsel_url %}
        {% url 'processing:select_starfind_batch' as tune_starfind_url %}
        {% for final, pending, by_status in by_channel %}
        {% with total=final|add:pending %}
        <td>
            <table>
                <tr>
                    <td colspan=2>
                        {% if step.0 == 'fit' and step.1 == 'magnitudes' %}
                        <a href="{{photrefsel_url}}">
                        Click to select reference frames<br/>
                        {% endif %}
                        {% if step.0 == 'find' and step.1 == 'stars' %}
                        <a href="{{tune_starfind_url}}">
                        Click to tune source extraction<br/>
                        {% endif %}
                        <div id="progress-with-label" 
                             style="width: 100%">
                            <span style="width: {% widthratio final total 100 %}%">
                                {{final}}/{{total}}
                            </span>
                            <progress value="{{ final }}" 
                                      max="{{ total }}" 
                                      class="lcars-u-2 lcars-rust-bg"
                                      style="foreground-color:black">
                            </progress>
                        </div>
                        {% if step.0 == 'fit' and step.1 == 'magnitudes' %}
                        </a">
                        {% endif %}
                    </td>
                </tr>
                {% for status, count in by_status %}
                <tr>
                    <td class="lcars-u-1">Status {{ status }}</td>
                    <td>
                        <div id="progress-with-label" 
                             style="width: 100%">
                            <span style="width:{% widthratio count pending 100 %}%">
                                {{count}}/{{pending}}
                            </span>
                            <progress value="{{ count }}" 
                                      max="{{ pending }}" 
                                      class="lcars-u-1 lcars-rust-bg"
                                      style="foreground-color:black">
                            </progress>
                        </div>
                    </td>

                </tr>
                {% endfor %}
            </table>
        </td>
        {% endwith %}
        {% endfor %}
        <td class="dropdown">
            {% if runs %}
            <div class="dropbtn
                               lcars-element 
                               button 
                               rounded 
                               lcars-husk-bg"
                 style="align-items: center;">
                Logs
            </div>
            <div class="dropdown-content">
                {% for run_id, started, finished in runs %}
                <a href="{% url 'processing:review' run_id 'INFO' %}"
                   class="dropdown-content">
                    Started {{started}}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
{% endblock main %}

